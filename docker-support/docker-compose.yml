x-common-env: &common-env
  TZ: "Asia/Shanghai"
  LANG: en_US.UTF-8
  LC_ALL: en_US.UTF-8

services:
  init-env:
    image: bash:5.2-alpine3.18
    container_name: init-env
    volumes:
      - ./scripts:/scripts
      - ./templates:/templates
      - ./config:/config
      - ./generated:/generated
      - ./logs:/logs
    restart: "no"
    network_mode: "host"
    command: |
      bash -c '
        ls -la /scripts/ &&
        chmod +x /scripts/init.sh &&
        bash /scripts/init.sh &&
        touch /generated/.init_complete
        echo "容器将保持运行"
        sleep 36000
      '
    healthcheck:
      test: ["CMD", "test", "-f", "/generated/.init_complete"]
      interval: 5s
      timeout: 10s
      retries: 10

  mysql:
    image: mysql:8.0.30
    container_name: mysql
    restart: always
    user: "1001:1001"
    depends_on:
      init-env:
        condition: service_healthy
    environment:
      <<: *common-env
      MYSQL_ROOT_PASSWORD: "root"
    ports:
      - "3906:3906"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./logs/mysql:/var/log/mysql
      - ./generated/mysql/support-files/my.cnf:/etc/mysql/conf.d/my.cnf:ro
      - ./generated/lighthouse/conf/ldp_docker.sql:/docker-entrypoint-initdb.d/10-ldp_docker.sql:ro
      - ./generated/lighthouse/conf/ldp_db.sql:/docker-entrypoint-initdb.d/20-ldp_db.sql:ro
  
  redis-node-1:
    image: redis:6.2.6
    container_name: redis-node-1
    restart: always
    depends_on:
      init-env:
        condition: service_healthy
    environment:
      - TZ=Asia/Shanghai
    ports:
      # 数据端口 (Data Port)
      - "7101:7101"
      # 集群总线端口 (Cluster Bus Port)
      - "17101:17101"
    volumes:
      - redis_data_1:/data
      - ./docker/plugins:/plugins  
      - ./generated/redis/conf/redis-7101.conf:/usr/local/etc/redis/redis.conf:ro
    # 显式启动命令：启用集群、指定端口、关闭守护进程、确保日志输出到 stdout
    command: redis-server /usr/local/etc/redis/redis.conf
    healthcheck:
      # 检查数据端口和密码
      test: ["CMD", "redis-cli", "-h", "localhost", "-p", "7101", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5        

  redis-node-2:
    image: redis:6.2.6
    container_name: redis-node-2
    restart: always
    depends_on:
      init-env:
        condition: service_healthy
    environment:
      - TZ=Asia/Shanghai
    ports:
      # 数据端口 (Data Port)
      - "7102:7102"
      # 集群总线端口 (Cluster Bus Port)
      - "17102:17102"
    volumes:
      - redis_data_2:/data
      - ./docker/plugins:/plugins  
      - ./generated/redis/conf/redis-7102.conf:/usr/local/etc/redis/redis.conf:ro
    # 显式启动命令：启用集群、指定端口、关闭守护进程、确保日志输出到 stdout
    command: redis-server /usr/local/etc/redis/redis.conf
    healthcheck:
      # 检查数据端口和密码
      test: ["CMD", "redis-cli", "-h", "localhost", "-p", "7102", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5  

  redis-node-3:
    image: redis:6.2.6
    container_name: redis-node-3
    restart: always
    depends_on:
      init-env:
        condition: service_healthy
    environment:
      - TZ=Asia/Shanghai
    ports:
      # 数据端口 (Data Port)
      - "7103:7103"
      # 集群总线端口 (Cluster Bus Port)
      - "17103:17103"
    volumes:
      - redis_data_3:/data
      - ./docker/plugins:/plugins  
      - ./generated/redis/conf/redis-7103.conf:/usr/local/etc/redis/redis.conf:ro
    # 显式启动命令：启用集群、指定端口、关闭守护进程、确保日志输出到 stdout
    command: redis-server /usr/local/etc/redis/redis.conf
    healthcheck:
      # 检查数据端口和密码
      test: ["CMD", "redis-cli", "-h", "localhost", "-p", "7103", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5  

  redis-node-4:
    image: redis:6.2.6
    container_name: redis-node-4
    restart: always
    depends_on:
      init-env:
        condition: service_healthy
    environment:
      - TZ=Asia/Shanghai
    ports:
      # 数据端口 (Data Port)
      - "7104:7104"
      # 集群总线端口 (Cluster Bus Port)
      - "17104:17104"
    volumes:
      - redis_data_4:/data
      - ./docker/plugins:/plugins  
      - ./generated/redis/conf/redis-7104.conf:/usr/local/etc/redis/redis.conf:ro
    # 显式启动命令：启用集群、指定端口、关闭守护进程、确保日志输出到 stdout
    command: redis-server /usr/local/etc/redis/redis.conf
    healthcheck:
      # 检查数据端口和密码
      test: ["CMD", "redis-cli", "-h", "localhost", "-p", "7104", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5  
      
  redis-node-5:
    image: redis:6.2.6
    container_name: redis-node-5
    restart: always
    depends_on:
      init-env:
        condition: service_healthy
    environment:
      - TZ=Asia/Shanghai
    ports:
      # 数据端口 (Data Port)
      - "7105:7105"
      # 集群总线端口 (Cluster Bus Port)
      - "17105:17105"
    volumes:
      - redis_data_5:/data
      - ./docker/plugins:/plugins  
      - ./generated/redis/conf/redis-7105.conf:/usr/local/etc/redis/redis.conf:ro
    # 显式启动命令：启用集群、指定端口、关闭守护进程、确保日志输出到 stdout
    command: redis-server /usr/local/etc/redis/redis.conf
    healthcheck:
      # 检查数据端口和密码
      test: ["CMD", "redis-cli", "-h", "localhost", "-p", "7105", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5  
      
  redis-node-6:
    image: redis:6.2.6
    container_name: redis-node-6
    restart: always
    depends_on:
      init-env:
        condition: service_healthy
    environment:
      - TZ=Asia/Shanghai
    ports:
      # 数据端口 (Data Port)
      - "7106:7106"
      # 集群总线端口 (Cluster Bus Port)
      - "17106:17106"
    volumes:
      - redis_data_6:/data
      - ./docker/plugins:/plugins  
      - ./generated/redis/conf/redis-7106.conf:/usr/local/etc/redis/redis.conf:ro
    # 显式启动命令：启用集群、指定端口、关闭守护进程、确保日志输出到 stdout
    command: redis-server /usr/local/etc/redis/redis.conf
    healthcheck:
      # 检查数据端口和密码
      test: ["CMD", "redis-cli", "-h", "localhost", "-p", "7106", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5                  
  
  redis-cluster-init:
    image: redis:6.2.6
    container_name: redis-cluster-init
    restart: "no"
    depends_on:
      redis-node-1:
        condition: service_healthy
      redis-node-2:
        condition: service_healthy
      redis-node-3:
        condition: service_healthy
      redis-node-4:
        condition: service_healthy
      redis-node-5:
        condition: service_healthy
      redis-node-6:
        condition: service_healthy
    volumes:
      - ./config:/config:ro
      - ./docker/plugins:/plugins  
    command: |
      bash -c '
        REDIS_PASSWORD=$(grep "cluster_passwd" /config/standalone-deploy.json | cut -d ":" -f 2 | tr -d " \n\r\t\",}")
        HOST_IP="redis-node-1"
        HOST_NAME="redis-node-1"
        echo "等待 Redis 节点完全启动,password:$$REDIS_PASSWORD"
        sleep 10
        IP_NODE1=$$(getent hosts redis-node-1 | awk "{print \$$1}")
        IP_NODE2=$$(getent hosts redis-node-2 | awk "{print \$$1}")
        IP_NODE3=$$(getent hosts redis-node-3 | awk "{print \$$1}")
        IP_NODE4=$$(getent hosts redis-node-4 | awk "{print \$$1}")
        IP_NODE5=$$(getent hosts redis-node-5 | awk "{print \$$1}")
        IP_NODE6=$$(getent hosts redis-node-6 | awk "{print \$$1}")
        echo "检查节点状态..."
        redis-cli -h $$IP_NODE1 -p 7101 -a "$$REDIS_PASSWORD" ping || exit 1
        redis-cli -h $$IP_NODE2 -p 7102 -a "$$REDIS_PASSWORD" ping || exit 1
        redis-cli -h $$IP_NODE3 -p 7103 -a "$$REDIS_PASSWORD" ping || exit 1
        redis-cli -h $$IP_NODE4 -p 7104 -a "$$REDIS_PASSWORD" ping || exit 1
        redis-cli -h $$IP_NODE5 -p 7105 -a "$$REDIS_PASSWORD" ping || exit 1
        redis-cli -h $$IP_NODE6 -p 7106 -a "$$REDIS_PASSWORD" ping || exit 1

        echo "所有节点状态正常，开始创建 Redis 集群 (3主3从)..."
        echo "yes" | redis-cli -a "$$REDIS_PASSWORD" --cluster create \
          $$IP_NODE1:7101 \
          $$IP_NODE2:7102 \
          $$IP_NODE3:7103 \
          $$IP_NODE4:7104 \
          $$IP_NODE5:7105 \
          $$IP_NODE6:7106 \
          --cluster-replicas 1

        if [ $$? -eq 0 ]; then
          echo "等待集群稳定..."
          sleep 10
          echo "Redis 集群创建完成！"
        else
          echo "集群创建失败，请检查日志"
          exit 1
        fi
      '        
  lighthouse-insights:
    build:
      context: .
      dockerfile: ./docker/Dockerfile-insights
    container_name: lighthouse-insights
    restart: always
    ports:
      - "9089:9089"  
    depends_on:
      - init-env
      - mysql
      - redis-cluster-init
    environment:
      SPRING_REDIS_HOST: redis-node-1
      SPRING_REDIS_PORT: 6379
      SPRING_REDIS_PASSWORD: naJKcZEoGGeSSAad
    volumes:
      - ./generated/lighthouse/conf/:/app/conf/:ro     

  lighthouse-frontend:
    build:
      context: .
      dockerfile: ./docker/Dockerfile-frontend
    container_name: lighthouse-frontend
    restart: always
    ports:
      - "8181:80"
    depends_on:
      - init-env
      - lighthouse-insights
    volumes:
      - ./generated/nginx/conf/nginx.conf:/etc/nginx/nginx.conf:ro    

  lighthouse-standalone:
    build:
      context: .
      dockerfile: ./docker/Dockerfile-standalone
    container_name: lighthouse-standalone
    restart: always
    ports:
      - "18101:18101"
      - "4061:4061"  
    depends_on:
      - init-env
      - mysql
      - redis-cluster-init
    volumes:
      - ./generated/lighthouse/conf/:/app/conf/:ro    

volumes:
  mysql_data:
  mysql_home:  
  redis_data_1:
  redis_data_2:
  redis_data_3:
  redis_data_4:
  redis_data_5:
  redis_data_6:

