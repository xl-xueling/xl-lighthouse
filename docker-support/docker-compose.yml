x-common-env: &common-env
  TZ: "Asia/Shanghai"
  LANG: en_US.UTF-8
  LC_ALL: en_US.UTF-8

services:
  setup-env:
    image: bash:5.2-alpine3.18
    volumes:
      - ./scripts:/scripts
      - ./templates:/templates
      - ./config:/config
      - ./generated:/generated
      - ./logs:/logs
    restart: "no"
    container_name: ${COMPOSE_PROJECT_NAME:-ldp}_setup-env
    network_mode: "host"
    command: |
      bash -c '
        chmod +x /scripts/init.sh &&
        bash /scripts/init.sh &&
        touch /generated/.init_complete
        echo "容器将保持运行"
        sleep 36000
      '
    healthcheck:
      test: ["CMD", "test", "-f", "/generated/.init_complete"]
      interval: 5s
      timeout: 10s
      retries: 10

  mysql:
    image: mysql:8.0.30
    restart: always
    container_name: ${COMPOSE_PROJECT_NAME:-ldp}_mysql
    user: "1001:1001"
    depends_on:
      setup-env:
        condition: service_healthy
    environment:
      <<: *common-env
      MYSQL_ROOT_PASSWORD: "root"
    ports:
      - "3906:3906"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./logs/mysql:/var/log/mysql
      - ./generated/mysql/support-files/my.cnf:/etc/mysql/conf.d/my.cnf:ro
      - ./generated/lighthouse/conf/ldp_docker.sql:/docker-entrypoint-initdb.d/10-ldp_docker.sql:ro
      - ./generated/lighthouse/conf/ldp_db.sql:/docker-entrypoint-initdb.d/20-ldp_db.sql:ro

  redis-node-1:
    build:
      context: .
      dockerfile: ./docker/Dockerfile-redis
    ports:
      - "7101:7101"
      - "17101:17101"
    volumes:
      - redis_data_1:/var/lib/redis/data
      - ./logs/redis:/var/log/redis
      - ./generated/redis/conf/redis-7101.conf:/usr/local/etc/redis/redis.conf:ro
    command: redis-server /usr/local/etc/redis/redis.conf
    restart: always
    container_name: ${COMPOSE_PROJECT_NAME:-ldp}_redis-node-1
    user: "1001:1001"
    depends_on:
      setup-env:
        condition: service_healthy
    environment:
      <<: *common-env
    healthcheck:
      test: ["CMD", "redis-cli", "-h", "localhost", "-p", "7101", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  redis-node-2:
    build:
      context: .
      dockerfile: ./docker/Dockerfile-redis
    ports:
      - "7102:7102"
      - "17102:17102"
    volumes:
      - redis_data_2:/var/lib/redis/data
      - ./logs/redis:/var/log/redis
      - ./generated/redis/conf/redis-7102.conf:/usr/local/etc/redis/redis.conf:ro
    command: redis-server /usr/local/etc/redis/redis.conf
    restart: always
    container_name: ${COMPOSE_PROJECT_NAME:-ldp}_redis-node-2
    user: "1001:1001"
    depends_on:
      setup-env:
        condition: service_healthy
    environment:
      <<: *common-env
    healthcheck:
      test: ["CMD", "redis-cli", "-h", "localhost", "-p", "7102", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  redis-node-3:
    build:
      context: .
      dockerfile: ./docker/Dockerfile-redis
    ports:
      - "7103:7103"
      - "17103:17103"
    volumes:
      - redis_data_3:/var/lib/redis/data
      - ./logs/redis:/var/log/redis
      - ./generated/redis/conf/redis-7103.conf:/usr/local/etc/redis/redis.conf:ro
    command: redis-server /usr/local/etc/redis/redis.conf
    restart: always
    container_name: ${COMPOSE_PROJECT_NAME:-ldp}_redis-node-3
    user: "1001:1001"
    depends_on:
      setup-env:
        condition: service_healthy
    environment:
      <<: *common-env
    healthcheck:
      test: ["CMD", "redis-cli", "-h", "localhost", "-p", "7103", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  redis-node-4:
    build:
      context: .
      dockerfile: ./docker/Dockerfile-redis
    ports:
      - "7104:7104"
      - "17104:17104"
    volumes:
      - redis_data_4:/var/lib/redis/data
      - ./logs/redis:/var/log/redis
      - ./generated/redis/conf/redis-7104.conf:/usr/local/etc/redis/redis.conf:ro
    command: redis-server /usr/local/etc/redis/redis.conf
    restart: always
    container_name: ${COMPOSE_PROJECT_NAME:-ldp}_redis-node-4
    user: "1001:1001"
    depends_on:
      setup-env:
        condition: service_healthy
    environment:
      <<: *common-env
    healthcheck:
      test: ["CMD", "redis-cli", "-h", "localhost", "-p", "7104", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  redis-node-5:
    build:
      context: .
      dockerfile: ./docker/Dockerfile-redis
    ports:
      - "7105:7105"
      - "17105:17105"
    volumes:
      - redis_data_5:/var/lib/redis/data
      - ./logs/redis:/var/log/redis
      - ./generated/redis/conf/redis-7105.conf:/usr/local/etc/redis/redis.conf:ro
    command: redis-server /usr/local/etc/redis/redis.conf
    restart: always
    container_name: ${COMPOSE_PROJECT_NAME:-ldp}_redis-node-5
    user: "1001:1001"
    depends_on:
      setup-env:
        condition: service_healthy
    environment:
      <<: *common-env
    healthcheck:
      test: ["CMD", "redis-cli", "-h", "localhost", "-p", "7105", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  redis-node-6:
    build:
      context: .
      dockerfile: ./docker/Dockerfile-redis
    ports:
      - "7106:7106"
      - "17106:17106"
    volumes:
      - redis_data_6:/var/lib/redis/data
      - ./logs/redis:/var/log/redis
      - ./generated/redis/conf/redis-7106.conf:/usr/local/etc/redis/redis.conf:ro
    command: redis-server /usr/local/etc/redis/redis.conf
    restart: always
    container_name: ${COMPOSE_PROJECT_NAME:-ldp}_redis-node-6
    user: "1001:1001"
    depends_on:
      setup-env:
        condition: service_healthy
    environment:
      <<: *common-env
    healthcheck:
      test: ["CMD", "redis-cli", "-h", "localhost", "-p", "7106", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  redis-cluster-init:
    image: redis:6.2.6
    restart: "no"
    container_name: ${COMPOSE_PROJECT_NAME:-ldp}_redis-cluster-init
    user: "1001:1001"
    depends_on:
      redis-node-1:
        condition: service_healthy
      redis-node-2:
        condition: service_healthy
      redis-node-3:
        condition: service_healthy
      redis-node-4:
        condition: service_healthy
      redis-node-5:
        condition: service_healthy
      redis-node-6:
        condition: service_healthy
    volumes:
      - ./config:/config:ro

    healthcheck:
      test: ["CMD", "sh", "-c", "test -f /tmp/cluster-ready && redis-cli -h redis-node-1 -p 7101 -a $(grep 'cluster_passwd' /config/standalone-deploy.json | cut -d':' -f2 | tr -d ' \",}') cluster info | grep -q 'cluster_state:ok'"]
      interval: 5s
      timeout: 5s
      retries: 30
      start_period: 30s
    command: |
      bash -c '
        set -e
        REDIS_PASSWORD=$$(grep "cluster_passwd" /config/standalone-deploy.json | cut -d ":" -f 2 | tr -d " \n\r\t\",}")
        sleep 10
        IP_NODE1=$$(getent hosts redis-node-1 | awk "{print \$$1}")
        IP_NODE2=$$(getent hosts redis-node-2 | awk "{print \$$1}")
        IP_NODE3=$$(getent hosts redis-node-3 | awk "{print \$$1}")
        IP_NODE4=$$(getent hosts redis-node-4 | awk "{print \$$1}")
        IP_NODE5=$$(getent hosts redis-node-5 | awk "{print \$$1}")
        IP_NODE6=$$(getent hosts redis-node-6 | awk "{print \$$1}")
        if redis-cli -h $$IP_NODE1 -p 7101 -a "$$REDIS_PASSWORD" cluster info 2>/dev/null | grep -q "cluster_state:ok"; then
          echo "Redis集群已存在"
          touch /tmp/cluster-ready
        else
          echo "开始创建Redis集群..."
          echo "yes" | redis-cli -a "$$REDIS_PASSWORD" --cluster create \
            $$IP_NODE1:7101 \
            $$IP_NODE2:7102 \
            $$IP_NODE3:7103 \
            $$IP_NODE4:7104 \
            $$IP_NODE5:7105 \
            $$IP_NODE6:7106 \
            --cluster-replicas 1
          echo "Redis集群创建完成"
          touch /tmp/cluster-ready
        fi

        for i in $$(seq 1 36); do
          if redis-cli -h $$IP_NODE1 -p 7101 -a "$$REDIS_PASSWORD" cluster info 2>/dev/null | grep -q "cluster_state:ok"; then
            echo "状态检查通过，容器将在5秒后退出"
            sleep 5
            exit 0
          fi
          sleep 5
        done
        echo "状态检查超时，容器退出"
        exit 1
      '
  insights:
    build:
      context: .
      dockerfile: ./docker/Dockerfile-insights
    restart: always
    container_name: ${COMPOSE_PROJECT_NAME:-ldp}_insights
    user: "1001:1001"
    ports:
      - "9089:9089"
    depends_on:
      setup-env:
        condition: service_healthy
      mysql:
        condition: service_started
      redis-cluster-init:
        condition: service_healthy
    volumes:
      - ./generated/lighthouse/conf/:/app/conf/:ro
      - ./logs/lighthouse-insights:/app/logs/lighthouse-insights

  frontend:
    build:
      context: .
      dockerfile: ./docker/Dockerfile-frontend
    restart: always
    container_name: ${COMPOSE_PROJECT_NAME:-ldp}_frontend
    user: "1001:1001"
    ports:
      - "8181:80"
    depends_on:
      setup-env:
        condition: service_healthy
      mysql:
        condition: service_started
      redis-cluster-init:
        condition: service_healthy
    volumes:
      - ./generated/nginx/conf/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./logs/nginx:/var/log/nginx

  standalone:
    build:
      context: .
      dockerfile: ./docker/Dockerfile-standalone
    restart: always
    container_name: ${COMPOSE_PROJECT_NAME:-ldp}_standalone
    user: "1001:1001"
    ports:
      - "18101:18101"
      - "4061:4061"
    depends_on:
      setup-env:
        condition: service_healthy
      mysql:
        condition: service_started
      redis-cluster-init:
        condition: service_healthy
    volumes:
      - ./generated/lighthouse/conf/:/app/conf/:ro
      - ./logs/lighthouse-standalone:/app/logs/lighthouse-standalone

volumes:
  mysql_data:
  mysql_home:
  redis_data_1:
  redis_data_2:
  redis_data_3:
  redis_data_4:
  redis_data_5:
  redis_data_6:

