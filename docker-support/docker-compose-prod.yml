x-common-env: &common-env
  TZ: "Asia/Shanghai"
  LANG: en_US.UTF-8
  LC_ALL: en_US.UTF-8

services:
  setup_env:
    image: bash:5.2-alpine3.18
    volumes:
      - ./scripts:/scripts
      - ./templates:/templates
      - ./config:/config
      - ./generated:/generated
      - ./logs:/logs
    restart: "no"
    container_name: ${COMPOSE_PROJECT_NAME:-ldp}_setup_env
    network_mode: "host"
    user: "root"
    command: |
      bash -c '
        chmod +x /scripts/entrypoint/init.sh &&
        bash /scripts/entrypoint/init.sh &&
        touch /generated/.init_complete
        echo "容器将保持运行"
        sleep 36000
      '
    healthcheck:
      test: [ "CMD", "test", "-f", "/generated/.init_complete" ]
      interval: 5s
      timeout: 10s
      retries: 10
  mysql:
    image: mysql:8.0.30
    restart: always
    container_name: ${COMPOSE_PROJECT_NAME:-ldp}_mysql
    user: "1001:1001"
    environment:
      <<: *common-env
      MYSQL_ROOT_PASSWORD: "root"
      UMASK: "0555"
    depends_on:
      setup_env:
        condition: service_healthy
    ports:
      - "3906:3906"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./logs/mysql:/var/log/mysql
      - ./generated/mysql/support-files/my.cnf:/etc/mysql/conf.d/my.cnf:ro
      - ./generated/lighthouse/conf/ldp_docker.sql:/docker-entrypoint-initdb.d/10-ldp_docker.sql:ro
      - ./generated/lighthouse/conf/ldp_db.sql:/docker-entrypoint-initdb.d/20-ldp_db.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "timeout 2 bash -c 'cat < /dev/null > /dev/tcp/127.0.0.1/3906'"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      private_net:
        ipv4_address: 10.183.0.2

  redis_node_1:
    image: dtstep/ldp-redis:${VERSION}
    ports:
      - "7101:7101"
      - "17101:17101"
    volumes:
      - redis_data_1:/var/lib/redis/data
      - ./logs/redis:/var/log/redis
      - ./generated/redis/conf/redis-7101.conf:/usr/local/etc/redis/redis.conf:ro
    command: redis-server /usr/local/etc/redis/redis.conf
    restart: always
    container_name: ${COMPOSE_PROJECT_NAME:-ldp}_redis_node_1
    user: "1001:1001"
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      <<: *common-env
    healthcheck:
      test: ["CMD", "redis-cli", "-h", "localhost", "-p", "7101", "ping"]
      interval: 5s
      timeout: 3s
      retries: 20
    networks:
      private_net:
        ipv4_address: 10.183.0.3

  redis_node_2:
    image: dtstep/ldp-redis:${VERSION}
    ports:
      - "7102:7102"
      - "17102:17102"
    volumes:
      - redis_data_2:/var/lib/redis/data
      - ./logs/redis:/var/log/redis
      - ./generated/redis/conf/redis-7102.conf:/usr/local/etc/redis/redis.conf:ro
    command: redis-server /usr/local/etc/redis/redis.conf
    restart: always
    container_name: ${COMPOSE_PROJECT_NAME:-ldp}_redis_node_2
    user: "1001:1001"
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      <<: *common-env
    healthcheck:
      test: ["CMD", "redis-cli", "-h", "localhost", "-p", "7102", "ping"]
      interval: 5s
      timeout: 3s
      retries: 20
    networks:
      private_net:
        ipv4_address: 10.183.0.4

  redis_node_3:
    image: dtstep/ldp-redis:${VERSION}
    ports:
      - "7103:7103"
      - "17103:17103"
    volumes:
      - redis_data_3:/var/lib/redis/data
      - ./logs/redis:/var/log/redis
      - ./generated/redis/conf/redis-7103.conf:/usr/local/etc/redis/redis.conf:ro
    command: redis-server /usr/local/etc/redis/redis.conf
    restart: always
    container_name: ${COMPOSE_PROJECT_NAME:-ldp}_redis_node_3
    user: "1001:1001"
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      <<: *common-env
    healthcheck:
      test: ["CMD", "redis-cli", "-h", "localhost", "-p", "7103", "ping"]
      interval: 5s
      timeout: 3s
      retries: 20
    networks:
      private_net:
        ipv4_address: 10.183.0.5

  redis_node_4:
    image: dtstep/ldp-redis:${VERSION}
    ports:
      - "7104:7104"
      - "17104:17104"
    volumes:
      - redis_data_4:/var/lib/redis/data
      - ./logs/redis:/var/log/redis
      - ./generated/redis/conf/redis-7104.conf:/usr/local/etc/redis/redis.conf:ro
    command: redis-server /usr/local/etc/redis/redis.conf
    restart: always
    container_name: ${COMPOSE_PROJECT_NAME:-ldp}_redis_node_4
    user: "1001:1001"
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      <<: *common-env
    healthcheck:
      test: ["CMD", "redis-cli", "-h", "localhost", "-p", "7104", "ping"]
      interval: 5s
      timeout: 3s
      retries: 20
    networks:
      private_net:
        ipv4_address: 10.183.0.6

  redis_node_5:
    image: dtstep/ldp-redis:${VERSION}
    ports:
      - "7105:7105"
      - "17105:17105"
    volumes:
      - redis_data_5:/var/lib/redis/data
      - ./logs/redis:/var/log/redis
      - ./generated/redis/conf/redis-7105.conf:/usr/local/etc/redis/redis.conf:ro
    command: redis-server /usr/local/etc/redis/redis.conf
    restart: always
    container_name: ${COMPOSE_PROJECT_NAME:-ldp}_redis_node_5
    user: "1001:1001"
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      <<: *common-env
    healthcheck:
      test: ["CMD", "redis-cli", "-h", "localhost", "-p", "7105", "ping"]
      interval: 5s
      timeout: 3s
      retries: 20
    networks:
      private_net:
        ipv4_address: 10.183.0.7

  redis_node_6:
    image: dtstep/ldp-redis:${VERSION}
    ports:
      - "7106:7106"
      - "17106:17106"
    volumes:
      - redis_data_6:/var/lib/redis/data
      - ./logs/redis:/var/log/redis
      - ./generated/redis/conf/redis-7106.conf:/usr/local/etc/redis/redis.conf:ro
    command: redis-server /usr/local/etc/redis/redis.conf
    restart: always
    container_name: ${COMPOSE_PROJECT_NAME:-ldp}_redis_node_6
    user: "1001:1001"
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      <<: *common-env
    healthcheck:
      test: ["CMD", "redis-cli", "-h", "localhost", "-p", "7106", "ping"]
      interval: 5s
      timeout: 3s
      retries: 20
    networks:
      private_net:
        ipv4_address: 10.183.0.8

  redis_cluster:
    image: dtstep/ldp-redis:${VERSION}
    restart: "no"
    container_name: ${COMPOSE_PROJECT_NAME:-ldp}_redis_cluster
    user: "1001:1001"
    depends_on:
      redis_node_1:
        condition: service_healthy
      redis_node_2:
        condition: service_healthy
      redis_node_3:
        condition: service_healthy
      redis_node_4:
        condition: service_healthy
      redis_node_5:
        condition: service_healthy
      redis_node_6:
        condition: service_healthy
    volumes:
      - ./config:/config:ro
    networks:
      private_net:
        ipv4_address: 10.183.0.9
    healthcheck:
      test: ["CMD", "sh", "-c", "test -f /tmp/cluster-ready && redis-cli -h redis_node_1 -p 7101 -a $(grep 'cluster_passwd' /config/standalone-deploy.json | cut -d':' -f2 | tr -d ' \",}') cluster info | grep -q 'cluster_state:ok'"]
      interval: 5s
      timeout: 5s
      retries: 30
      start_period: 30s
    command: |
      bash -c '
        set -e
        REDIS_PASSWORD=$$(grep "cluster_passwd" /config/standalone-deploy.json | cut -d ":" -f 2 | tr -d " \n\r\t\",}")
        sleep 15
        IP_NODE1=$$(getent hosts redis_node_1 | awk "{print \$$1}")
        IP_NODE2=$$(getent hosts redis_node_2 | awk "{print \$$1}")
        IP_NODE3=$$(getent hosts redis_node_3 | awk "{print \$$1}")
        IP_NODE4=$$(getent hosts redis_node_4 | awk "{print \$$1}")
        IP_NODE5=$$(getent hosts redis_node_5 | awk "{print \$$1}")
        IP_NODE6=$$(getent hosts redis_node_6 | awk "{print \$$1}")
        if redis-cli -h $$IP_NODE1 -p 7101 -a "$$REDIS_PASSWORD" cluster info 2>/dev/null | grep -q "cluster_state:ok"; then
          echo "Redis集群已存在"
          touch /tmp/cluster-ready
        else
          # 创建集群
          echo "开始创建Redis集群..."
          echo "yes" | redis-cli -a "$$REDIS_PASSWORD" --cluster create \
            $$IP_NODE1:7101 \
            $$IP_NODE2:7102 \
            $$IP_NODE3:7103 \
            $$IP_NODE4:7104 \
            $$IP_NODE5:7105 \
            $$IP_NODE6:7106 \
            --cluster-replicas 1
          echo "Redis集群创建完成"
          touch /tmp/cluster-ready
        fi

        for i in $$(seq 1 90); do
          if redis-cli -h $$IP_NODE1 -p 7101 -a "$$REDIS_PASSWORD" cluster info 2>/dev/null | grep -q "cluster_state:ok"; then
            echo "状态检查通过，容器将在5秒后退出"
            sleep 10
            exit 0
          fi
          sleep 2
        done
        echo "状态检查超时，容器退出"
        exit 1
      '

  insights:
    image: dtstep/ldp-insights:${VERSION}
    restart: always
    container_name: ${COMPOSE_PROJECT_NAME:-ldp}_insights
    user: "1001:1001"
    environment:
      <<: *common-env
    ports:
      - "9089:9089"
    depends_on:
      mysql:
        condition: service_healthy
      redis_cluster:
        condition: service_healthy
    volumes:
      - ./config/standalone-config.json:/app/runtime/config.json:ro
      - ./generated/lighthouse/conf/:/app/conf/:ro
      - ./logs/lighthouse-insights:/app/logs/lighthouse-insights
    networks:
      private_net:
        ipv4_address: 10.183.0.21
    healthcheck:
      test: ["CMD-SHELL", "timeout 2 bash -c 'cat < /dev/null > /dev/tcp/127.0.0.1/9089'"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  frontend:
    image: dtstep/ldp-frontend:${VERSION}
    restart: always
    container_name: ${COMPOSE_PROJECT_NAME:-ldp}_frontend
    user: "1001:1001"
    environment:
      <<: *common-env
    ports:
      - "8181:80"
    depends_on:
      mysql:
        condition: service_healthy
      redis_cluster:
        condition: service_healthy
    volumes:
      - ./generated/nginx/conf/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./logs/nginx:/var/log/nginx
    networks:
      private_net:
        ipv4_address: 10.183.0.22
    healthcheck:
      test: ["CMD-SHELL", "timeout 2 bash -c 'cat < /dev/null > /dev/tcp/127.0.0.1/80'"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  standalone:
    image: dtstep/ldp-standalone:${VERSION}
    restart: always
    container_name: ${COMPOSE_PROJECT_NAME:-ldp}_standalone
    user: "1001:1001"
    environment:
      <<: *common-env
    ports:
      - "18101:18101"
      - "4061:4061"
    depends_on:
      mysql:
        condition: service_healthy
      redis_cluster:
        condition: service_healthy
    volumes:
      - ./config/standalone-config.json:/app/runtime/config.json:ro
      - ./generated/lighthouse/conf/:/app/conf/:ro
      - ./logs/lighthouse-standalone:/app/logs/lighthouse-standalone
    healthcheck:
      test: ["CMD-SHELL", "timeout 2 bash -c 'cat < /dev/null > /dev/tcp/127.0.0.1/4061'"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      private_net:
        ipv4_address: 10.183.0.23

  demo_init:
    image: dtstep/ldp-demo-init:${VERSION}
    profiles:
      - demo
    restart: "no"
    container_name: ${COMPOSE_PROJECT_NAME:-ldp}_demo_init
    user: "1001:1001"
    depends_on:
      insights:
        condition: service_healthy
      standalone:
        condition: service_healthy
    volumes:
      - ./config/standalone-config.json:/app/runtime/config.json:ro
      - ./generated/lighthouse/conf/:/app/conf/:ro
      - ./logs/lighthouse-demo:/app/logs/lighthouse-demo
    networks:
      private_net:
        ipv4_address: 10.183.0.24
    healthcheck:
      test: ["CMD", "test", "-f", "/tmp/init_complete"]
      interval: 5s
      timeout: 3s
      retries: 10

  demo_start:
    image: dtstep/ldp-demo-start:${VERSION}
    profiles:
      - demo
    restart: "no"
    container_name: ${COMPOSE_PROJECT_NAME:-ldp}_demo_start
    user: "1001:1001"
    depends_on:
      insights:
        condition: service_healthy
      standalone:
        condition: service_healthy
      demo_init:
        condition: service_completed_successfully
    volumes:
      - ./config/standalone-config.json:/app/runtime/config.json:ro
      - ./generated/lighthouse/conf/:/app/conf/:ro
      - ./logs/lighthouse-demo:/app/logs/lighthouse-demo
    networks:
      private_net:
        ipv4_address: 10.183.0.25

  verifier:
    image: busybox:latest
    container_name: ${COMPOSE_PROJECT_NAME:-ldp}_verifier
    restart: "no"
    networks:
      private_net:
        ipv4_address: 10.183.0.30
    depends_on:
      redis_cluster:
        condition: service_healthy
      standalone:
        condition: service_healthy
      insights:
        condition: service_healthy
      frontend:
        condition: service_healthy
      mysql:
        condition: service_healthy
    command: |
      sh -c '
        echo "Start Complete, All services are healthy."
        touch /tmp/start-complete
      '

volumes:
  mysql_data:
  redis_data_1:
  redis_data_2:
  redis_data_3:
  redis_data_4:
  redis_data_5:
  redis_data_6:

networks:
  private_net:
    driver: bridge
    ipam:
      config:
        - subnet: 10.183.0.0/24
          gateway: 10.183.0.1

